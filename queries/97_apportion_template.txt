 
-- intermediary query 3: weighted cost of creator jobs on each cluster, as well as % cluster used (assumes only tasks run on clusters)




-- intermediary query 3: weighted cost of creator jobs on each cluster, as well as % cluster used (assumes only tasks run on clusters)
CREATE OR REPLACE VIEW  finops.system_lookups.v_shared_cluster_job_duration_weighted_cost AS 
SELECT job_duration.job_name, 
job_duration.job_id, 
job_duration.usage_date,
job_duration.cluster_id,
job_duration.cluster_name,
job_duration.cluster_data_security_mode,
job_duration.cluster_source,
cluster_cost_duration.workspace_name,
-- (sum of creator task duration) / (total of task duration on cluster)
sum(job_duration.day_cluster_job_task_exec_duration) job_exec_duration,
min(cluster_cost_duration.day_cluster_task_exec_duration) cluster_exec_duration,
job_exec_duration/cluster_exec_duration as exec_duration_cluster_pct,
-- these calculations have a fixed daily grain
min(cluster_cost_duration.day_cluster_est_dbu_cost)*exec_duration_cluster_pct as exec_duration_weighted_cluster_cost
FROM finops.system_lookups.v_shared_cluster_job_duration job_duration
INNER JOIN finops.system_lookups.v_shared_cluster_job_duration_cost AS cluster_cost_duration
ON (job_duration.cluster_id=cluster_cost_duration.cluster_id AND job_duration.usage_date=cluster_cost_duration.usage_date )
GROUP BY job_duration.job_name, job_duration.usage_date,job_duration.cluster_id, job_duration.job_id,job_duration.cluster_name, job_duration.cluster_data_security_mode,job_duration.cluster_source,cluster_cost_duration.workspace_name;